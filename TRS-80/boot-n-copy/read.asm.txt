00100         ORG     0C000H00105         DI00110         LD      A,100120         LD      (37E1H),A00180         LD      D,1700190         LD      E,200195         LD      (TS),DE00200 LOOP    LD      DE,(TS)00205         LD      A,E00210         CP      10D00220         JR      Z,KEY00230         LD      BC,BUFFER00240         CALL    READ00250         JR      NZ,DSK00260         LD      HL,BUFFER       ;POINT TO DIR SEC00270         LD      B,800280 FILE    LD      A,(HL)00290         BIT     4,A00300         JR      Z,KILL00310         LD      A,'A'00330         CALL    33H00350         JR      CONT00360 KILL    LD      A,'K'00380         CALL    33H00400 CONT    LD      A,' '00405         CALL    33H00410         PUSH    HL00420         LD      DE,500430         ADD     HL,DE00440         CALL    FP00450         POP     HL00460         LD      DE,3200470         ADD     HL,DE00490         DJNZ    FILE00500         LD      DE,(TS)00505         INC     E00506         LD      (TS),DE00510         JP      LOOP00700 FP      PUSH    HL00710         POP     IX00720         LD      A,0DH00730         LD      (IX+11),A00740         PUSH    HL00770 PRINT   LD      A,(HL)00780         CALL    33H00790         CP      0DH00800         JR      Z,TURN00810         INC     HL00820         JR      PRINT00850 TURN    POP     HL00860         RET04000 DSK     LD      HL,3C00H04010         LD      (HL),'E'04020         INC     HL04030         LD      (HL),'R'04040         INC     HL04050         LD      (HL),'R'04060 KEY     CALL    40H04070         JP      402DH05000 ;SECTOR READ.05010 ;ON ENTRY --> D=TRACK, E=SECTOR, BC=MEM LOC TO PUT SECTOR05020 READ    PUSH    BC05022         LD      A,105024         LD      (37E1H),A05030         CALL    TRY05040         POP     HL05050         RET     Z05060         LD      B,H05070         LD      C,L             ;TRY SECOND TIME ON ERROR05080 TRY     LD      (37EEH),DE      ;SET TRK & SECTOR05090         LD      HL,37ECH        ;COMMAND REG05100         LD      (HL),1BH        ;SEEK WITH LARGE DELAY05110         EX      (SP),HL05120         EX      (SP),HL05130         EX      (SP),HL05140         EX      (SP),HL         ;DIGEST COMAND05150 WAIT    LD      A,(HL)05160         RRCA                    ;WAIT TILL DSK READY05170         JR      C,WAIT05180         LD      (HL),88H        ;READ BYTE COMAND05190         PUSH    DE05200         LD      DE,37EFH        ;DATA REGISTER05210         EX      (SP),HL05220         EX      (SP),HL         ;DELAY05230         JR      DOIT05240 AGAIN   RRCA                    ;TEST FOR SEC END OR ERR05250         JR      NC,FIN05260 DOIT    LD      A,(HL)          ;GET STATUS05270         BIT     01,A            ;DRQ TEST05280         JR      Z,AGAIN         ;NOT READY. TEST FOR ERR05290         LD      A,(DE)05300         LD      (BC),A          ;GET AND SAVE DATA05310         INC     BC              ;NEXT LOC TO SAVE DATA05320         JR      DOIT05330 FIN     LD      A,(HL)          ;RESTORE STATUS05340         AND     1CH             ;TEST FOR THE 3 ERRORS05350         POP     DE              ;RESTORE TRK & SEC05360         RET     Z               ;RET IF NORMAL END05370         LD      (HL),0D0H       ;FOURCE INTERUPT05380         RET05381 TS      DEFS    205390 BUFFER  DEFS    25605400 